<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<html layout:decorate="~{layout}">

<head>
	<title>상품 상세페이지</title>

</head>
<div layout:fragment="content" class="container">
	<!--shop style link-->
	<link rel="stylesheet" th:href="@{/css/place_detail.css}">

	<!-- Bootstrap CSS -->
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

	<!-- Bootstrap JS (필요한 경우 Popper.js 포함) -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
	<!-- 한글 언어 파일 추가 -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.kr.min.js"></script>

	<!-- Tempus Dominus (다른 날짜 선택기) 관련 링크는 필요에 따라 유지 -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/js/tempusdominus-bootstrap-4.min.js"></script>




	<!-- 가게 정보 요약 & 주문 폼 -->
	<div class="container p-5 pt-0 my-5">
		<section class="placeInfo row p-5 rounded-2">
			<div class="placeImg col-5">
				<!-- 상품이미지 -->
				<div class="card-img-wrapper rounded-2 mb-3">
					<div class="card-img-box" th:style="|background-image: url(@{  ${store.stoImage}  });|"></div>
				</div>
			</div> <!--placeImg-->
			<div class="col-7 card">
				<!-- 상품정보 -->
				<div class="card-body">
					<p class="card-text placeTitle d-flex justify-content-between align-items-center">
						<span th:text="${store.stoTitle}"></span>
						<span class="icons d-flex align-items-center">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#808080"
								class="bi bi-eye" viewBox="0 0 16 16">
								<path
									d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z" />
								<path
									d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0" />
							</svg>
							<span th:text="${store.viewCount}"></span>

							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
								class="bi bi-chat" viewBox="0 0 16 16">
								<path
									d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105" />
							</svg>
							<span th:text="${store.storeReviews.size}"></span>

							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
								class="bi bi-heart" viewBox="0 0 16 16">
								<path
									d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15" />
							</svg>
							<span th:text="${store.favoriteStores.size}"></span>
						</span>
					</p>
					<h3 class="placeName card-title" th:text="${store.stoName}"></h3>
					<p class="placeDesc card-text" th:text="${store.stoContent}"></p>
					<table class="table">
						<tbody>

							<tr>
								<td><strong>카테고리</strong></td>
								<td><span th:text="${store.stoCategory}"></span></td>
							</tr>

							<tr>
								<td><strong>연락처</strong></td>
								<td><span th:text="${store.stoContact}"></span></td>
							</tr>
							<tr>
								<td><strong>주소</strong></td>
								<td><span th:text="${store.stoAddress}"></span></td>
							</tr>
							<tr>
								<td><strong>운영 시간</strong></td>
								<td><span th:text="${store.stoOperatingHours}"></span></td>
							</tr>
							<tr>
								<td><strong>휴무일</strong></td>
								<td><span th:text="${store.stoClosedDays}"></span></td>
							</tr>
							<tr>
								<td><strong>평점</strong></td>
								<td><span th:text="${store.recommendationCount}"></span></td>
							</tr>
							<tr>
								<td><strong>추천 메뉴</strong></td>
								<td><span th:text="${store.stoRecommendedMenu}"></span></td>
							</tr>
							<tr>
								<td><strong>주차 정보</strong></td>
								<td><span th:text="${store.stoParkingInfo}"></span></td>
							</tr>
							<tr>
								<td><strong>채식종류</strong></td>
								<td><span th:text="${store.stoVegetarianType}"></span></td>
							</tr>
							<tr>
								<td><strong>영업 여부</strong></td>
								<td><span th:text="${store.isOpen} ? '영업 중' : '영업 종료'"></span></td>
							</tr>
						</tbody>
					</table>

					<span class="favorite-btn btn hm-btn-green w-25" th:data-userid="${session.UserId}"
						th:data-storeid="${store.stoId}">찜👍</span>
					<span class='btn hm-btn-green reservation-btn w-25' th:data-userid="${session.UserId}"
						th:data-storeid="${store.stoId}" th:data-openhours="${store.stoOperatingHours}">예약🗓️</span>
					<div th:id="'reservationForm_' + ${store.stoId}" class="reservationBox p-3" style="display: none;">
						<h5>예약 시간 선택</h5>
						<div class="form-group">
							<label th:for="'reservationDate_' + ${store.stoId}">예약 날짜 선택:</label>
							<div class="input-group">
								<input type="text" class="form-control" th:id="'reservationDate_' + ${store.stoId}"
									placeholder="YYYY-MM-DD" required>
								<div class="input-group-append">
									<span class="input-group-text">
										<i class="fa fa-calendar" aria-hidden="true"></i>
									</span>
								</div>
							</div>
						</div>

						<div class="form-group my-2">
							<label th:for="'reservationTime_' + ${store.stoId}">예약 시간 선택:</label>
							<select th:id="'reservationTime_' + ${store.stoId}" class="form-control">
								<!-- 여기서 JavaScript로 동적으로 옵션 추가 -->
							</select>
						</div>

						<button class="btn btn-primary" onclick="makeReservation()">확인</button>
						<button class="btn btn-secondary" onclick="hideReservationForm()">취소</button>
					</div>
				</div> <!-- //card-body -->
			</div> <!--col-6 card-->
		</section> <!--placeInfo-->

	</div>
	<!-- 상점별 리뷰 -->
	<section class="storeReview my-5 p-3">
		<h3 class="my-3 fw-bold">상점 후기</h3>

		<!-- 이미지 보기 -->
		<div th:if="${filteredReviewsCount <= 8}">
			<div class="revImgWrapper" th:if="${filteredReviewsCount != 0}">
				<div class="revImgContainer ">
					<div class="carousel-inner justify-content-start">
						<th:block th:each="review, iterStat : ${filteredReviews}">
							<div class="carousel-item "
								th:class="'carousel-item ' + (${iterStat.index < 8} ? 'active' : '')">
								<a href="#" class="revImgLink d-block">
									<div class="revImgBox" th:style="'background-image: url(' + ${review.revImg} + ');'"
										th:data-img-url="${review.revImg}" th:data-sto-name="${store.stoName}"
										th:data-rev-text="${review.revText}" th:data-rev-rating="${review.revRating}"
										th:data-created-at="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}"
										onclick="openModal(this)"></div>
								</a>
							</div>
						</th:block>
					</div> <!-- carousel-inner -->
				</div> <!-- revImgContainer -->
			</div> <!-- revImgWrapper -->
		</div>
		<div id="reviewCarousel" class="carousel slide" th:if="${filteredReviewsCount > 8}">
			<div class="revImgWrapper">
				<div class="revImgContainer">
					<div class="carousel-inner">
						<th:block th:each="review, iterStat : ${filteredReviews}">
							<div class="carousel-item "
								th:class="'carousel-item ' + (${iterStat.index < 8} ? 'active' : '')">
								<span class="revImgLink d-block">
									<div class="revImgBox" th:style="'background-image: url(' + ${review.revImg} + ');'"
										th:data-img-url="${review.revImg}" th:data-sto-name="${store.stoName}"
										th:data-rev-text="${review.revText}" th:data-rev-rating="${review.revRating}"
										th:data-created-at="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}"
										onclick="openModal(this)"></div>
								</span>
							</div>
						</th:block>
					</div> <!-- carousel-inner -->
					<a class="carousel-control-prev">
						<span class="carousel-control-prev-icon" aria-hidden="true"></span>
						<span class="visually-hidden">이전</span>
					</a>
					<a class="carousel-control-next">
						<span class="carousel-control-next-icon" aria-hidden="true"></span>
						<span class="visually-hidden">다음</span>
					</a>
				</div> <!-- revImgContainer -->
			</div> <!-- revImgWrapper -->
		</div> <!-- reviewCarousel -->

		<!-- 리뷰 보기 블록 -->
		<div id="reviews my-3">
			<div class="row border-bottom my-2">
				<span class="my-2">총
					<span th:text="${store.storeReviews.size()}"></span>
					개
				</span>

			</div>
			<div th:if="${store.storeReviews.size() == 0}" class="no-reviews-box text-center p-4 border rounded">
				<h5 class="mb-3">아직 후기가 없습니다!</h5>
				    <p>첫 번째 후기를 남겨주세요.</p>
				    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="#808080" class="bi bi-chat" viewBox="0 0 16 16">
				        <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105" />
				    </svg>
			</div>
			<div class="row border-bottom reviewBlock py-2 my-3"
				th:each="review : ${store.storeReviews}">

				<div class="col-md-2 writer">[[${review.writer}]]</div>
				<div class="col-md-10">
					<div class="row revText justify-content-start mb-3 revStoName">
						<div class="col">[[${store.stoName}]]</div>
					</div>

					<div class="row revText justify-content-start my-3">
						<div class="col">[[${review.revText}]]</div>
					</div>
					<div class="row revImgRow justify-content-start">
						<div class="col">
							<div class="revImgBox" th:if="${review.revImg != null}"
								th:style="'background-image: url(' + ${review.revImg} + ');'"
								th:data-img-url="${review.revImg}" th:data-sto-name="${store.stoName}"
								th:data-rev-text="${review.revText}" th:data-rev-rating="${review.revRating}"
								th:data-created-at="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}"
								onclick="openModal(this)">
							</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 1}">별점: ★☆☆☆☆</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 2}">별점: ★★☆☆☆</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 3}">별점: ★★★☆☆</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 4}">별점: ★★★★☆</div>
							<div class="col" id="ratingContainer" th:if="${review.revRating == 5}">별점: ★★★★★</div>
						</div>
					</div>
					<div class="row createdAt justify-content-start my-3">
						<div class="col">
							<small th:text="${#temporals.format(review.createdAt, 'yyyy.MM.dd.hh.mm.ss')}"></small>
						</div>
					</div>
					<button th:if="${review.writer == session.UserId}" class="delete-review btn btn-danger" th:data-rev-id="${review.revId}">삭제</button>
				</div>
			</div>
			<button id="loadMoreButton" class="btn btn-primary my-3" style="display: none;">리뷰 더보기</button>
		</div>
		
		<div class="btn hm-btn-border-green reviewFormBtn my-2 w-25">
			후기 작성하기
		</div>
		<!-- 모달 구조 -->
		<div id="imageModal" class="modal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">사진 후기</h5>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-7 ">
								<img id="modalImage" src="" alt="리뷰 이미지" class="img-fluid">
							</div>
							<div class="col-5">
								<p>가게명 : <span id="modalStoName"></span></p>
								<p>내용 : <span id="modalRevText"></span></p>
								<p id="modalRevRating"></p>
								<p>작성일 : <small id="modalCreatedAt"></small></p>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" onclick="closeModal()">닫기</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 리뷰 추가 폼 -->
		<form id="reviewForm" enctype="multipart/form-data" class="p-4 my-2 no-reviews-box" >
			<h3 class="my-3">후기 작성</h3>
			<h5>장소 만족도</h5>
			<div id="starRating">
				<span class="star" data-value="1">★</span>
				<span class="star" data-value="2">★</span>
				<span class="star" data-value="3">★</span>
				<span class="star" data-value="4">★</span>
				<span class="star" data-value="5">★</span>
			</div>
			<h5 class="my-2">장소 후기</h5>
			<textarea id="revText" placeholder="상점 후기를 남겨주세요" required class="my-2 p-4 row"></textarea>
			<input type="hidden" id="revRating" required />
			<div class="row my-4">
				<h5>사진 올리기</h5>
				<input type="file" id="revImg" accept="image/*" />
			</div>
			<button type="submit" class="btn hm-btn-green">리뷰 추가</button>
		</form>


	</section>
	<button class="btn btn-danger" th:if="${session.UserId == 'admin'}" th:id="'delete-' + ${store.stoId}"
		th:onclick="'deleteStore(' + ${store.stoId} + ')'" >가게 삭제</button>
	<a th:if="${session.UserId == 'admin'}" th:href="@{/load/store/update(id=${store.stoId})}" class="btn btn-info"
		id="updateButton">가게 수정</a>
	<script>
		function deleteStore(stoId) {
			// 삭제 확인 대화 상자
			const isConfirmed = confirm("정말로 이 가게를 삭제하시겠습니까?")

			if (isConfirmed) {
				fetch(`/load/store/delete/${stoId}`, {
					method: 'DELETE'
				})
					.then(response => {
						if (response.ok) {
							alert("가게가 삭제되었습니다.");
							window.location.href = 'http://localhost:8080/load/place'; // 페이지 리다이렉트
						} else {
							alert("가게 삭제에 실패했습니다.");
						}
					});
			} else {
				alert("가게 삭제가 취소되었습니다.");
			}
		}

		function openModal(element) {
			const imgUrl = element.getAttribute('data-img-url');
			const stoName = element.getAttribute('data-sto-name');
			const revText = element.getAttribute('data-rev-text');
			const revRating = element.getAttribute('data-rev-rating');
			const createdAt = element.getAttribute('data-created-at');

			// 모달에 정보 설정
			document.getElementById('modalImage').src = imgUrl; // 이미지 URL 설정
			document.getElementById('modalStoName').innerText = stoName; // 상호명 설정
			document.getElementById('modalRevText').innerText = revText; // 리뷰 텍스트 설정
			document.getElementById('modalRevRating').innerText = `별점: ${'★'.repeat(revRating)}${'☆'.repeat(5 - revRating)}`; // 별점 설정
			document.getElementById('modalCreatedAt').innerText = createdAt; // 생성 날짜 설정

			$('#imageModal').modal('show'); // Bootstrap 모달 열기
		}

		function closeModal() {
			$('#imageModal').modal('hide'); // Bootstrap 모달 닫기
		}

		document.addEventListener('DOMContentLoaded', function () {
			const stars = document.querySelectorAll('.star');
			const revRatingInput = document.getElementById('revRating');
			stars.forEach(star => {
				star.addEventListener('click', function () {
					const rating = this.getAttribute('data-value');
					revRatingInput.value = rating; // 평점 값을 숨겨진 입력 필드에 저장
					updateStarDisplay(rating); // 별점 표시 업데이트
				});
			});

			function updateStarDisplay(rating) {
				stars.forEach(star => {
					if (star.getAttribute('data-value') <= rating) {
						star.classList.add('selected'); // 선택된 별점에 스타일 추가
					} else {
						star.classList.remove('selected');
					}
				});
			}

			document.getElementById('reviewForm').addEventListener('submit', function (event) {
				event.preventDefault(); // 기본 폼 제출 방지

				const formData = new FormData();
				formData.append('revText', document.getElementById('revText').value);
				formData.append('revRating', revRatingInput.value); // 평점 추가

				// 파일이 선택되지 않았더라도 리뷰를 추가할 수 있도록 수정
				const revImg = document.getElementById('revImg').files[0];
				if (revImg) {
					formData.append('revImg', revImg); // 파일 추가
				}

				const pathParts = window.location.pathname.split('/'); // 경로를 '/'로 나누기
				const placeId = pathParts[pathParts.length - 1]; // 마지막 부분이 placeId

				// 리뷰 추가 API 호출
				fetch(`http://localhost:8080/load/place/${placeId}/reviews`, {
					method: 'POST',
					body: formData
				})
					.then(response => {
						if (response.ok) {
							return response.json(); // JSON 응답을 반환
						} else if (response.status === 401) {
							alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
							window.location.href = 'http://localhost:8080/member/login'; // 로그인 페이지로 리다이렉트
							return Promise.reject(); // 리다이렉트 후 함수 종료
						} else if (response.status === 400) {
							alert('리뷰 텍스트가 비어 있습니다.'); // 잘못된 요청 처리
							return;
						} else {
							throw new Error('서버 오류가 발생했습니다. 상태 코드: ' + response.status);
						}
					})
					.then(data => {
						// 성공적으로 리뷰가 추가되면 UI 업데이트
						alert('리뷰가 추가되었습니다!');
						document.getElementById('reviewForm').reset(); // 폼 초기화
						location.reload(); // 페이지 새로고침
					})
					.catch(error => {
						console.error('Error:', error);
						alert('오류가 발생했습니다: ' + error.message);
					});
			});

			const reviewBlocks = document.querySelectorAll('.reviewBlock'); // 모든 리뷰 블록 선택
			const loadMoreButton = document.getElementById('loadMoreButton'); // "더보기" 버튼 선택

			let currentIndex = 0; // 현재 보여주는 리뷰 인덱스

			// 초기 5개 리뷰만 보여주는 함수
			function showInitialReviews() {
				const totalReviews = reviewBlocks.length; // 총 리뷰 수
				for (let i = 0; i < totalReviews; i++) {
					if (i < 5) {
						reviewBlocks[i].style.display = 'flex'; // 처음 5개 리뷰 보이기
					} else {
						reviewBlocks[i].style.display = 'none'; // 나머지 리뷰 숨기기
					}
				}
				currentIndex = 5; // 현재 인덱스 업데이트
				loadMoreButton.style.display = currentIndex < totalReviews ? 'block' : 'none'; // "더보기" 버튼 표시
			}

			// "더보기" 버튼 클릭 시 호출되는 함수
			loadMoreButton.addEventListener('click', function () {
				const totalReviews = reviewBlocks.length; // 총 리뷰 수
				for (let i = currentIndex; i < currentIndex + 5 && i < totalReviews; i++) {
					reviewBlocks[i].style.display = 'flex'; // 다음 5개 리뷰 보이기
				}
				currentIndex += 5; // 현재 인덱스 업데이트
				loadMoreButton.style.display = currentIndex < totalReviews ? 'block' : 'none'; // "더보기" 버튼 표시
			});

			showInitialReviews(); // 초기 리뷰 표시
		});

		// 리뷰 삭제 기능
		document.querySelectorAll('.delete-review').forEach(button => {
			button.addEventListener('click', function () {
				const revId = this.getAttribute('data-rev-id'); // 리뷰 ID 가져오기
				const confirmed = confirm('정말로 이 리뷰를 삭제하시겠습니까?'); // 삭제 확인
				const pathParts = window.location.pathname.split('/'); // 경로를 '/'로 나누기
				const placeId = pathParts[pathParts.length - 1]; // 마지막 부분이 placeId
				if (confirmed) {
					// 리뷰 삭제 API 호출
					fetch(`http://localhost:8080/load/place/${placeId}/reviews/${revId}`, {
						method: 'DELETE'
					})
						.then(response => {
							if (response.ok) {
								alert('리뷰가 삭제되었습니다!');
								location.reload(); // 페이지 새로고침
							} else {
								throw new Error('리뷰 삭제에 실패했습니다.');
							}
						})
						.catch(error => {
							console.error('Error:', error);
							alert('오류가 발생했습니다: ' + error.message);
						});
				}
			});
		});
		window.onload = function () {
			const pathParts = window.location.pathname.split('/'); // 경로를 '/'로 나누기
			const placeId = pathParts[pathParts.length - 1]; // 마지막 부분이 placeId
			// 리뷰 추가 API 호출
			fetch(`http://localhost:8080/load/place/${placeId}/reviews`)
				.then(response => response.json())
				.then(data => {
					data.forEach(review => addReviewToUI(review));
				})
				.catch(error => console.error('Error fetching reviews:', error));
		};
		$(document).ready(function () {
			const reviewFormBtn = $(".reviewFormBtn")
			
			reviewFormBtn.click(function(){
				$("#reviewForm").slideToggle(); // 슬라이드 효과 추가
			})
			const carouselItems = $('#reviewCarousel .carousel-item');
			const totalItems = carouselItems.length;
			let nextcurrentIndex = 7;
			let prevcurrentIndex = 0;

			// 다음 버튼 클릭 이벤트
			$('.carousel-control-next').click(function () {
				if (nextcurrentIndex < totalItems - 1) {
					// 현재 아이템에서 active 클래스 제거
					carouselItems.eq(prevcurrentIndex).removeClass('active');
					prevcurrentIndex++;
					// 인덱스 증가
					nextcurrentIndex++;
					// 다음 아이템에 active 클래스 추가
					carouselItems.eq(nextcurrentIndex).addClass('active');
				} else {
					alert("다음 이미지가 없습니다.")
				}
			});

			// 이전 버튼 클릭 이벤트
			$('.carousel-control-prev').click(function () {
				if (prevcurrentIndex > 0) {
					// 현재 아이템에서 active 클래스 제거
					carouselItems.eq(nextcurrentIndex).removeClass('active');
					nextcurrentIndex--;
					// 인덱스 감소
					prevcurrentIndex--;
					// 이전 아이템에 active 클래스 추가
					carouselItems.eq(prevcurrentIndex).addClass('active');
				} else {
					alert("이전 이미지가 없습니다.")
				}
			});

			const favoriteButtons = document.querySelectorAll('.favorite-btn');

			favoriteButtons.forEach(button => {
				button.addEventListener('click', function () {
					const userId = this.getAttribute('data-userid');
					const storeId = this.getAttribute('data-storeid');
					addFavorite(userId, storeId);
				});
			});

			const reservationButtons = document.querySelectorAll('.reservation-btn');

			reservationButtons.forEach(button => {
				button.addEventListener('click', function () {
					const userId = this.getAttribute('data-userid');
					const storeId = this.getAttribute('data-storeid');
					const openhours = this.getAttribute('data-openhours');
					showReservationForm(userId, storeId, openhours)
				})
			})
		});

		function addFavorite(memberId, stoId) {
			console.log('memberId:', memberId); // 디버깅용 출력
			console.log('stoId:', stoId); // 디버깅용 출력
			fetch(`/store/favorite/add?memberId=${memberId}&stoId=${stoId}`, { // 서버의 API 엔드포인트
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({memberId: memberId, stoId: stoId})
			})
				.then(response => {
					if (response.ok) {
						alert('찜하기에 성공했습니다!');
					} else {
						return response.text().then(text => {
							alert(text); // 서버에서 전송한 예외 메시지를 사용자에게 표시
						});
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('서버 오류가 발생했습니다.');
				});
		}

		//예약 시간 함수
		function populateReservationTimes(operatingHours) {
			const timeSelect = document.getElementById(`reservationTime_${window.currentStoId}`);
			timeSelect.innerHTML = ''; // 기존 옵션 삭제

			const [start, end] = operatingHours.split(' - '); // 시작 시간과 종료 시간 분리
			const [startHour, startMinute] = start.split(':').map(Number);
			const [endHour, endMinute] = end.split(':').map(Number);
			const interval = 30; // 간격 (분 단위)

			const now = new Date(); // 현재 시간
			const currentHour = now.getHours();
			const currentMinute = now.getMinutes();

			// 종료 시간에서 30분 전 계산
			let adjustedEndHour = endHour;
			let adjustedEndMinute = endMinute - 30;

			if (adjustedEndMinute < 0) {
				adjustedEndHour -= 1;
				adjustedEndMinute += 60; // 60분으로 보정
			}

			// 종료 시간이 0시가 되지 않도록 처리
			if (adjustedEndHour < startHour) {
				adjustedEndHour = startHour;
				adjustedEndMinute = 0;
			}

			for (let hour = startHour; hour <= adjustedEndHour; hour++) {
				for (let minute = (hour === startHour ? startMinute : 0); minute < 60; minute += interval) {
					if (hour === adjustedEndHour && minute > adjustedEndMinute) break; // 조정된 종료 시간 초과 시 중단

					// 현재 시간보다 이전의 옵션 제거
					if (hour < currentHour || (hour === currentHour && minute <= currentMinute)) {
						continue; // 이전 시간은 건너뜀
					}

					const formattedHour = hour.toString().padStart(2, '0');
					const formattedMinute = minute.toString().padStart(2, '0');
					const optionValue = `${formattedHour}:${formattedMinute}`;
					const option = document.createElement('option');
					option.value = optionValue;
					option.textContent = optionValue;
					timeSelect.appendChild(option);
				}
			}
		}


		// 예약 폼이 열릴 때 시간 옵션을 채우도록 변경
		function showReservationForm(userId, stoId, operatingHours) {
			document.getElementById(`reservationForm_${stoId}`).style.display = 'block';
			window.currentUserId = userId;
			window.currentStoId = stoId;
			populateReservationTimes(operatingHours); // 시간 옵션 채우기


			// Bootstrap Datepicker 초기화 (한글 설정)
			$(`#reservationDate_${stoId}`).datepicker({ // 수정
				format: 'yyyy-mm-dd',
				autoclose: true,
				todayHighlight: true,
				language: "kr",
				startDate: new Date() // 오늘 날짜부터 선택 가능
			}).datepicker('setDate', new Date()); // 오늘 날짜로 초기화


		}


		function makeReservation() {
			const reservationDate = $(`#reservationDate_${window.currentStoId}`).val();
			const reservationTime = $(`#reservationTime_${window.currentStoId}`).val();
			const userId = window.currentUserId;

			if (userId == '로그인되지 않았습니다.') {
				alert(userId)
				return; // 로그인되지 않은 경우 예약을 중단
			}

			const stoId = window.currentStoId; // 이 값이 Long으로 변환될 수 있도록 설정

			const reservationData = {
				userId: userId,
				stoId: stoId,
				reservationTime: `${reservationDate} ${reservationTime}`,
			};

			fetch('/store/reservations', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(reservationData),
			})
				.then(response => {
					if (!response.ok) {
						return response.json().then(err => {
							throw new Error(err.message || '예약 요청 중 오류가 발생했습니다.');
						});
					}
					return response.json();
				})
				.then(data => {
					alert('예약이 완료되었습니다!');
					hideReservationForm();  // 예약 완료 후 폼 숨기기
				})
				.catch(error => {
					alert(error.message);
				});
		}

		function hideReservationForm() {
			document.getElementById(`reservationForm_${window.currentStoId}`).style.display = 'none'; // 수정
		}


	</script>
</div> <!--//layout::content-->

<!-- <script layout:fragment="script"> -->

</html>