<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>주문내역</title>
	
	
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
	      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
	        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
	        crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
	        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
	        crossorigin="anonymous"></script>
	<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
	<link rel="stylesheet"
	      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"/>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=28da3dbc8c389b574e0c32075b4e02ba"></script>
	<link rel="stylesheet" href="/css/layout.css"/>
	
	
	<!-- font font-awesome CDN -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
	      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
	      crossorigin="anonymous" referrerpolicy="no-referrer"/>
	
	<!-- 제이쿼리 라이브러리 로드 -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	
	
	<!--swiper cdn-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
	<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
	
	
	<!--order style link-->
	<link rel="stylesheet" th:href="@{/css/order.css}">
	
	<!--order js link-->
	<script src="/js/order.js"></script>


</head>

<body>
<div class="d-flex flex-column min-vh-100 border border-5 border-success" id="wrapper">
	
	<div layout:fragment="content" class="container">
		
		<!--페이지 제목-->
		<div class="row my-5">
			<div class="pageTitle col text-center">
				주문 내역
			</div>
		</div>
		
		<section class="row vstack orderItem position-relative mb-5" th:fragment="polist">
			
			<p class="subtle f18 c666 fw-bold">
				주문 내역
			</p>
			
			<div class="col gap-3 g-3" th:each="poHistory, iterStat : ${poHistoryList}">
				<div class="card " style="max-width: 800px;">
					<div class="card-header border-bottom-0 pb-0 d-flex flex-row align-items-center justify-content-between">
						<span class="c333 fw700 f18" style="color: white;">[[${poHistory.orderStatus}]]</span>
						<a th:href="@{|/order/po/detail/${poHistory.orderId}|}" class="f12 align-text-bottom c888">주문상세내역
							&raquo;</a>
					</div>
					
					<!-- 주문 상품 목록 th:block-->
					<div class="orderItemTable card-body gap-2 bg-light vstack">
						<th:block th:each="orderItem, iterStat : ${poHistory.orderItems}">
							<div class="d-flex gap-3 border-bottom border-light bg-white rounded-2 px-3">
								
								<!-- 상품이미지 -->
								<div class="vstack gap-2 prodImageBoxWrapper my-3">
									
									<div class="prodImageBox border flex-grow-0"
									     style="aspect-ratio: 1; background-size: cover; background-position: center;  max-width: 140px;"
									     th:style="|background-image: url(@{  ${orderItem.prodThumb}  }); width: 100%; aspect-ratio: 1; background-size: cover; background-position: center;|">
									</div>
								</div> <!-- // prodImageBoxWrapper -->
								
								
								<div class="d-flex flex-column pl-3 ml-3 calcItem my-3 clearfix align-items-stretch flex-grow-1">
									<h5 class="card-title fw700 c444 f18 mb-2 d-inline-block" th:text="${orderItem.prodName}">상품명</h5>
									<!--상품명-->
									
									<p class="card-text d-inline-block mb-1">
	
										<span class="card-text text-end d-inline-block c333 fw700 commaNums f16"
										      th:attr="data-nums=${orderItem.sumFinalPrice}">상품금액합계</span>
										<span class="f14 won">원</span>
									
									
									</p>
									
									
									<p class="card-text d-inline-flex gap-2  flex-grow-1 align-items-end">
										<span
												class="btn badge rounded-pill border-secondary-subtle text-secondary f14 py-2 px-3 d-inline-block">주문취소</span>
										
										<span
												class="btn badge rounded-pill border-success text-success f14 py-2 d-inline-block flex-grow-1 openReviewFormBtn"
												th:attr="data-product-id=${orderItem.prodId}">리뷰쓰기</span>
									</p>
								
								</div>
							
							</div>
						</th:block> <!--//orderItemList-->
						<div class="text-end bg-light cart-text pt-2">
							<span class="d-inline-block c333 fw700 commaNums f22"
							      th:attr="data-nums=${poHistory.totalPrice}">주문금액총합계</span>
							<span class="f18 won fw500 c666">원</span>
						
						</div>
					</div> <!-- //card-body -->
					
					
					<!--///////////////////////////////////////-->
					<!--///////////////////////////////////////-->
					<!--///////////////////////////////////////-->
					
					
					<div class="card-footer border-top-0 pt-0 d-flex flex-row align-items-center justify-content-between">
						<span class="f14 c999"><span
								th:text="${#temporals.format(poHistory.paidAt,'yyyy. MM. dd')}"></span> 구매</span>
						<span class="btn badge text-bg-success f16">리뷰쓰고 추가 마일리지 적립 혜택을 받으세요</span>
					</div> <!-- //card-footer -->
				</div> <!-- //card -->
			</div> <!-- //col -->
		
		
		
		
			<style>
	        #drop-area {
	            border: 2px dashed #ccc;
	            padding: 20px;
	            width: 300px;
	            margin: 0 auto;
	            text-align: center;
	        }
	
	        #drop-area.highlight {
	            border-color: purple;
	        }
	
	        #gallery img {
	            width: 100px;
	            margin: 10px;
	        }

          .star-rating {
              direction: rtl;
              display: inline-flex;
          }

          .star-rating input[type="radio"] {
              display: none;
          }

          .star-rating label {
              font-size: 2em;
              color: #ddd;
              cursor: pointer;
          }

          .star-rating input[type="radio"]:checked ~ label {
              color: #ffc107;
          }

          .star-rating label:hover,
          .star-rating label:hover ~ label {
              color: #ffc107;
          }
			</style>
			
			<script th:inline="javascript">
	
	        $(document).on("click",  ".openReviewFormBtn" ,function () {
	            let prodId = $(this).attr("data-product-id");
                $(".reviewWrap").remove();
	
	            // 리뷰 폼을 동적으로 생성
	            let reviewForm = `
	        <div class="card-text reviewWrap">
	            <form id="reviewForm" enctype="multipart/form-data">
	                <div class="row">
	                    <div class="col-6 modalColLeft border">
	                        <div id="drop-area">
	                            <h3>이미지를 여기에 드래그 앤 드롭하세요</h3>
	                            <input type="file" class="form-control" name="prodRevImgList" id="prodRevImg" accept="image/*" multiple>
	                            <label class="button" for="prodRevImg">또는 파일 선택</label>
	                            <div id="gallery"></div>
	                        </div>
	                    </div>
	
	                    <div class="col-6 modalColRight">
		                    <p>
											    <label for="rating" class="form-label">평점</label>
											    <div class="star-rating">
											        <input type="radio" id="star5" name="rating" value="5" />
											        <label for="star5" title="5 stars">&#9733;</label>
											        <input type="radio" id="star4" name="rating" value="4" />
											        <label for="star4" title="4 stars">&#9733;</label>
											        <input type="radio" id="star3" name="rating" value="3" />
											        <label for="star3" title="3 stars">&#9733;</label>
											        <input type="radio" id="star2" name="rating" value="2" />
											        <label for="star2" title="2 stars">&#9733;</label>
											        <input type="radio" id="star1" name="rating" value="1" />
											        <label for="star1" title="1 star">&#9733;</label>
											    </div>
												</p>
<!--	                        <p>
	                            <label for="prodName" class="form-label">상품명</label>
	                            <input type="text" class="form-control" id="prodName" name="prodName" />
	                        </p>-->
	                        <p>
	                            <label for="revText" class="form-label">리뷰내용</label>
	                            <input type="text" class="form-control" id="revText" name="revText" />
	                        </p>
	
	                        <input type="hidden" id="prodId" name="prodId" value="${prodId}" />
	                        <button type="button" id="submitReviewForm" class="btn btn-primary">리뷰 제출</button>
	                    </div>
	                </div>
	            </form>
	        </div>
	    `;
	
	            // 동적으로 생성된 폼을 DOM에 추가
	            $(this).parent().after(reviewForm);
	
	
	            const dropArea = document.getElementById("drop-area");
	        const gallery = document.getElementById("gallery");
	        const fileInput = document.getElementById("prodRevImg");
	
	        let filesArray = []; // 업로드할 파일들을 저장할 배열
	
	        // Prevent default behaviors
	        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
	            dropArea.addEventListener(eventName, preventDefaults, false);
	            document.body.addEventListener(eventName, preventDefaults, false);
	        });
	
	        function preventDefaults(e) {
	            e.preventDefault();
	            e.stopPropagation();
	        }
	
	        // Highlight drop area when item is dragged over it
	        ['dragenter', 'dragover'].forEach(eventName => {
	            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
	        });
	
	        ['dragleave', 'drop'].forEach(eventName => {
	            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
	        });
	
	        // Handle dropped files
	        dropArea.addEventListener('drop', handleDrop, false);
	        fileInput.addEventListener('change', handleFiles, false);
	
	        function handleDrop(e) {
	            const dt = e.dataTransfer;
	            const files = dt.files;
	            handleFiles({target: {files: files}});
	        }
	
	        function handleFiles(e) {
	            const newFiles = Array.from(e.target.files);
	
	            document.getElementById('prodRevImg').files = e.target.files;
	
	            if (filesArray.length + newFiles.length > 3) {
	                alert('최대 3개의 이미지만 업로드할 수 있습니다.');
	                return;
	            }
	
	            filesArray = filesArray.concat(newFiles).slice(0, 3); // 3개까지만 허용
	            gallery.innerHTML = ''; // 기존 미리보기 초기화
	            filesArray.forEach(previewFile);
	        }
	
	        function previewFile(file) {
	            const reader = new FileReader();
	            reader.readAsDataURL(file);
	            reader.onloadend = function () {
	                const img = document.createElement('img');
	                img.src = reader.result;
	                img.style.width = '100px';
	                img.style.margin = '10px';
	                gallery.appendChild(img);
	            }
	        }
	
	        
	            // 리뷰 제출 버튼 클릭 이벤트
	            $('#submitReviewForm').on('click', function () {
	                // FormData 생성
	                let formData = new FormData(document.getElementById('reviewForm'));
	
	                // AJAX로 FormData 전송
	                $.ajax({
	                    url: `/shop/review/${prodId}`,  // 리뷰 저장 엔드포인트
	                    type: 'POST',
	                    data: formData,
	                    processData: false,  // FormData는 자동으로 처리되므로 false로 설정
	                    contentType: false,  // FormData는 multipart/form-data로 전송되므로 false로 설정
	                    success: function (response) {
	                        Swal.fire('리뷰가 성공적으로 저장되었습니다!', '', 'success');
	                        // 성공 시 페이지 새로고침이나 다른 동작을 수행할 수 있음
	                    },
	                    error: function (xhr, status, error) {
	                        Swal.fire('리뷰 저장에 실패했습니다.', '', 'error');
	                    }
	                });
	            });
	        });
			
			
			</script>
		
		</section> <!--		//orderItem-->
	</div> <!-- //content container -->

</div><!-- // #wrapper -->
<!--daum 주소 입력 api-->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!--order js link-->
<script src="/js/order.js"></script>

</body>

</html>